@using WorkFlow.PWA.Areas.PlanesModulo.Components
@using WorkFlow.Share.Objetos.Planes;
@inherits EngramaComponent

<MudGrid>
	<!-- Encabezado del Proyecto -->
	<MudItem xs="12">
		<CardProyecto Proyecto="@Data.ProyectoSelected"></CardProyecto>
	</MudItem>

	<!-- Selector de Fases (Tabs horizontales) -->
	<MudItem xs="12">
		<MudPaper Elevation="2" Class="pa-4">
			<MudText Typo="Typo.h6" Class="mb-3">Fases del Proyecto</MudText>
			<MudChipSet T="Fases" @bind-SelectedChip="selectedFaseChip" 
						Color="Color.Success">
				@foreach (var fase in Data.ProyectoSelected.fases)
				{
					<MudChip Text="@fase.nvchTitulo" 
							 Value="@fase"
							 OnClick="@(() => OnClickFaseSelected(fase))">
						@fase.nvchTitulo
					</MudChip>
				}
			</MudChipSet>
		</MudPaper>
	</MudItem>

	@if (Data.FaseSelected?.iIdFase > 0)
	{
		<!-- Panel dividido: Pasos a la izquierda, Chat a la derecha -->
		<MudItem xs="12" md="4">
			<MudPaper Elevation="2" Class="pa-4" Style="height: calc(100vh - 350px); overflow-y: auto;">
				<MudText Typo="Typo.h6" Class="mb-3">
					<MudIcon Icon="@Icons.Material.Filled.FormatListNumbered" Class="mr-2" />
					Pasos de la Fase
				</MudText>
				
				<MudList Clickable="true" @bind-SelectedValue="selectedPasoValue">
					@foreach (var paso in Data.FaseSelected.pasos.OrderBy(p => p.smNumeroSecuencia))
					{
						<MudListItem Value="@paso" 
									 OnClick="@(() => OnClickPasoSelected(paso))"
									 Class="@(Data.PasoSelected?.iIdPaso == paso.iIdPaso ? "mud-success-text" : "")">
							<MudPaper Elevation="@(Data.PasoSelected?.iIdPaso == paso.iIdPaso ? 4 : 1)" 
									  Class="pa-3 mb-2"
									  Style="@(Data.PasoSelected?.iIdPaso == paso.iIdPaso ? "border-left: 4px solid var(--mud-palette-success);" : "")">
								<div class="d-flex align-center mb-2">
									<MudChip Size="Size.Small" 
											 Color="@(Data.PasoSelected?.iIdPaso == paso.iIdPaso ? Color.Success : Color.Default)">
										Paso @paso.smNumeroSecuencia
									</MudChip>
									@if (Data.PasoSelected?.iIdPaso == paso.iIdPaso)
									{
										<MudIcon Icon="@Icons.Material.Filled.CheckCircle" 
												 Color="Color.Success" 
												 Size="Size.Small" 
												 Class="ml-auto" />
									}
								</div>
								
								<MudText Typo="Typo.body2" Class="mb-2">
									<strong>Descripción:</strong> @GetTruncatedText(paso.nvchDescripcion, 80)
								</MudText>
								
								@if (Data.PasoSelected?.iIdPaso == paso.iIdPaso)
								{
									<MudText Typo="Typo.body2" Class="mb-1">
										<strong>Propósito:</strong> @paso.nvchProposito
									</MudText>
									<MudText Typo="Typo.body2" Class="mb-1">
										<strong>Características:</strong> @paso.nvchCaracteristicas
									</MudText>
									<MudText Typo="Typo.body2">
										<strong>Enfoque:</strong> @paso.nvchEnfoque
									</MudText>
								}
							</MudPaper>
						</MudListItem>
					}
				</MudList>
			</MudPaper>
		</MudItem>

		<MudItem xs="12" md="8">
			@if (Data.PasoSelected?.iIdPaso > 0)
			{
				 <ChatLLMComponent Paso="@Data.PasoSelected" 
								  Fase="@Data.FaseSelected"
								  Proyecto="@Data.ProyectoSelected" /> 
			}
			else
			{
				<MudPaper Elevation="2" Class="pa-8 text-center" Style="height: calc(100vh - 350px);">
					<MudIcon Icon="@Icons.Material.Filled.TouchApp" 
							 Style="font-size: 4rem;" 
							 Color="Color.Default" 
							 Class="mb-4" />
					<MudText Typo="Typo.h5" Color="Color.Default">
						Selecciona un paso para comenzar
					</MudText>
					<MudText Typo="Typo.body1" Color="Color.Default" Class="mt-2">
						Elige uno de los pasos de la izquierda para iniciar la conversación con el asistente
					</MudText>
				</MudPaper>
			}
		</MudItem>
	}
	else
	{
		<!-- Estado vacío cuando no hay fase seleccionada -->
		<MudItem xs="12">
			<MudPaper Elevation="0" Class="pa-8 text-center">
				<MudIcon Icon="@Icons.Material.Filled.Lightbulb" 
						 Style="font-size: 5rem;" 
						 Color="Color.Primary" 
						 Class="mb-4" />
				<MudText Typo="Typo.h4" Class="mb-2">
					¡Comienza seleccionando una fase!
				</MudText>
				<MudText Typo="Typo.body1" Color="Color.Default">
					Selecciona una de las fases anteriores para ver sus pasos y comenzar a trabajar
				</MudText>
			</MudPaper>
		</MudItem>
	}
</MudGrid>

@code {
	
}